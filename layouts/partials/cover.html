{{- with .cxt}} {{/* Apply proper context from dict */}}
{{- if (and .Params.cover.image (not $.isHidden)) }}
<figure class="entry-cover">
    {{- $loading := cond $.IsSingle "eager" "lazy" }}
    {{- $addLink := (and site.Params.cover.linkFullImages $.IsSingle) }}
    {{- $prod := (hugo.IsProduction | or (eq site.Params.env "production")) }}

    {{- /* Use singleImage on article pages when available */ -}}
    {{- $coverImage := .Params.cover.image }}
    {{- if and $.IsSingle .Params.cover.singleImage }}
        {{- $coverImage = .Params.cover.singleImage }}
    {{- end }}

    {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
    {{- if and $.IsSingle .Params.cover.singleAlt }}
        {{- $alt = .Params.cover.singleAlt }}
    {{- end }}

    {{- $responsiveImages := (.Params.cover.responsiveImages | default site.Params.cover.responsiveImages) | default true }}

    {{- $pageBundleCover := (.Resources.ByType "image").GetMatch (printf "*%s*" $coverImage) }}
    {{- $globalResourcesCover := (resources.ByType "image").GetMatch (printf "*%s*" $coverImage) }}
    {{- $cover := (or $pageBundleCover $globalResourcesCover)}}

    {{- $sizes := (slice "360" "480" "720" "1080" "1500") }}
    {{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif") -}}
    {{- if hugo.IsExtended -}}
        {{- $processableFormats = $processableFormats | append "webp" -}}
    {{- end -}}

    {{- $imgdl := $coverImage | absURL }}
    {{- if $cover -}}
        {{- $imgdl = $cover.Permalink }}
    {{- end -}}

    {{- if $addLink }}
        <a href="{{ $imgdl }}" target="_blank" rel="noopener noreferrer">
    {{- end }}

    {{- if $cover -}}
        {{- if (and (in $processableFormats $cover.MediaType.SubType) ($responsiveImages) (eq $prod true)) }}
            <img loading="{{$loading}}"
                {{- if $.IsSingle }} fetchpriority="high"{{ end }}
                decoding="async"
                srcset='{{- range $size := $sizes -}}
                            {{- if (ge $cover.Width $size) }}
                                {{- printf "%s %s" (($cover.Resize (printf "%sx webp" $size)).Permalink) (printf "%sw," $size) }}
                            {{- end }}
                        {{- end }}
                        {{- printf "%s %dw" (($cover.Resize (printf "%dx webp" $cover.Width)).Permalink) ($cover.Width) }}'
                sizes="(min-width: 768px) 720px, 100vw"
                src="{{ ($cover.Resize "720x webp").Permalink }}"
                width="{{ $cover.Width }}" height="{{ $cover.Height }}"
                alt="{{ $alt }}">
        {{- else }}
            <img loading="{{ $loading }}" src="{{ $imgdl }}" alt="{{ $alt }}">
        {{- end }}
    {{- else }}
        <img loading="{{ $loading }}" src="{{ $imgdl }}" alt="{{ $alt }}">
    {{- end }}

    {{- if $addLink }}
        </a>
    {{- end -}}

    {{- if $.IsSingle }}
        {{ with .Params.cover.caption -}}
            <figcaption>{{ . | markdownify }}</figcaption>
        {{- end }}
    {{- end }}
</figure>
{{- end }}{{/* End image */}}
{{- end -}}{{/* End context */ -}}
